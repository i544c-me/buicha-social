---
- name: 'Provision Image'
  hosts: default
  become: true

  tasks:
    - name: Install system dependencies
      package:
        name:
          - curl
          - wget
          - gnupg
          - apt-transport-https
          - lsb-release
          - ca-certificates
          - acl # become を上手く機能するために必要
        state: present

    - name: Get Node.js setup
      get_url:
        url: https://deb.nodesource.com/setup_18.x
        dest: /root/node_setup.sh
        mode: '0777'
    - name: Install Node.js
      shell: |
        bash /root/node_setup.sh
        apt install -y nodejs
        corepack enable
        corepack prepare pnpm@latest --activate

    - name: Install packages
      package:
        name:
          - nginx
        state: present

    - name: Add user, misskey
      user:
        name: misskey
        shell: /usr/bin/bash

    - name: Clone misskey
      git:
        repo: https://github.com/misskey-dev/misskey.git
        dest: /home/misskey/misskey
        version: 13.3.1
      become_user: misskey

    # Edit https://github.com/misskey-dev/misskey/blob/develop/.config/example.yml
    - name: Copy config
      copy:
        src: ./default.yml
        dest: /home/misskey/misskey/.config/default.yml
      become_user: misskey

    - name: Install misskey
      shell: |
        cd /home/misskey/misskey && \
        git submodule update --init && \
        pnpm install --frozen-lockfile && \
        pnpm run build
      environment:
        NODE_ENV: production
      become_user: misskey