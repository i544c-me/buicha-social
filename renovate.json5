{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:base",
    ":label(renovate)",
    "schedule:weekends",
    "github>aquaproj/aqua-renovate-config#2.3.1",
  ],
  "dependencyDashboard": true,
  "automerge": true,
  "packageRules": [
    // Terraform やそのプロバイダーのバージョンアップをまとめ、これは AutoMerge しない
    {
      "groupName": "terraform-providers",
      "matchManagers": ["asdf"],
      "matchDepNames": ["terraform", "tflint"],
      "automerge": false,
    },
    {
      "groupName": "terraform-providers",
      "matchManagers": ["tflint-plugin"],
      "matchDepNames": ["terraform-linters/tflint-ruleset-aws"],
    },
    {
      "groupName": "terraform-providers",
      "matchManagers": ["terraform"],
    },
    {
      // aqua での terraform のバージョン管理
      "groupName": "terraform-providers",
      "matchDepNames": ["hashicorp/terraform"],
    },

    // AMI ID の更新
    {
      "matchDepNames": ["image_id"],
      "automerge": false,
    },

    // aqua の更新だけ rebase を無効化する
    // aqua の checksum 更新で上手く automerge しなくなるため
    {
      "matchFileNames": ["aqua.yaml"],
      "ignoreDeps": ["hashicorp/terraform"],
      "rebaseWhen": "never",
    },
  ],

  "customManagers": [
    // AMI ID の更新
    {
      "customType": "regex",
      "fileMatch": ["\\.tf$"],
      "matchStrings":
        [
          ".*amiFilter=(?<packageName>.*?)\n(.*currentImageName=(?<currentDigest>.*?)\n)?(.*\n)?.*?(?<depName>[a-zA-Z0-9-_:]*)[ ]*?[:|=][ ]*?[\"|']?(?<currentValue>ami-[a-z0-9]{17})[\"|']?.*",
        ],
      "datasourceTemplate": "aws-machine-image",
      "versioningTemplate": "aws-machine-image",
    },
  ],
}
